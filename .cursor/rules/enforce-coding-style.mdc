---
description: Enforce consistent coding style across Python files
globs: **/*.py
alwaysApply: false
---

# Enforce Coding Style

All Python code in this project MUST follow consistent coding standards.

## Naming Conventions

| Element | Convention | Example |
|---------|------------|---------|
| Classes | CamelCase | `BotApplication`, `TimeEvent` |
| Methods | snake_case | `register_event`, `send_messages` |
| Functions | snake_case | `get_credentials`, `format_message` |
| Variables | snake_case | `event_tasks`, `is_valid` |
| Constants | UPPER_SNAKE_CASE | `CANCELLED`, `DIALOG_DEBUG` |
| Private | _prefix | `_instance`, `_value` |

## Function Formatting

**3+ parameters:** Multi-line with trailing comma

```python
def initialize(
    cls,
    token: str,
    chat_id: str,
    logger: logging.Logger,
) -> "BotApplication":
```

**2 or fewer parameters:** Single line

```python
def register_event(self, event: "Event") -> None:
```

## Docstrings (Google Style)

Every function and class MUST have a docstring:

```python
def function_name(param1: Type1, param2: Type2) -> ReturnType:
    """Brief one-line description ending with period.
    
    Args:
        param1: Description of param1.
        param2: Description of param2.
        
    Returns:
        Description of return value.
    """
```

## Code Quality

- No unused imports
- No unused parameters (except in overridden methods)
- All imports at top of file
- No code duplication (3+ similar blocks â†’ extract to helper)
- No trailing whitespace

## Exception Handling

### TelegramMessage subclasses

All Telegram API send errors are handled in the `TelegramMessage.send()` base class.
Subclasses MUST override `_send_impl()` with their happy-path logic and MUST NOT
add their own try/except blocks (except for expected non-error exceptions like
"message is not modified" in `TelegramRemoveKeyboardMessage`).

Subclasses that send HTML-parsed text MUST override `_get_error_text()` to return
the text that could trigger `InvalidHtmlError`.

`InvalidHtmlError` is a fatal error -- it propagates up and terminates the bot.

### Polling

Telegram API receive errors (`TimedOut`, `NetworkError`) are handled in `poll_updates()`.
Do NOT add redundant try/except for these errors in callers of `poll_updates()`.

### Conditions and message builders

Conditions and message builders should never raise. Do NOT wrap calls to
`condition.check()`, `message_builder.build()`, or `send_messages()` in try/except.
If they do raise, it is a fatal bug that should propagate up and terminate the bot.

### Logging exceptions

Use `exc_info=True` (or `logger.exception()` at ERROR level) for all exception logging
to include the full traceback. Do NOT use `logger.error("... error=%s", exc)`.

- **CRITICAL** -- fatal errors that terminate the bot
- **ERROR** -- recoverable errors that are logged and swallowed

## Subagent

For comprehensive style enforcement, use the `code-style-enforcer` subagent.
